<!doctype html>
<html lang="de-DE">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#1f232a" />
  <title>Zeit</title>
  <link rel="icon" href="icons/icon.svg" type="image/svg+xml">
  <link rel="stylesheet" href="styles.css?v=20260227" />
  <link rel="manifest" href="manifest.webmanifest" />
</head>

<body data-theme="medium">
  <header class="top">
    <div class="top__left">
      <div class="brand">ZEIT</div>
      <div class="clock mono" id="bigClock">--:--:--</div>
      <div class="date" id="todayLine">—</div>
    </div>

    <div class="top__right">
      <div class="tabs" role="tablist" aria-label="Modus">
        <button class="tab is-active" id="tabNormal" type="button">Normal</button>
        <button class="tab" id="tabMobi" type="button">Mobi</button>
      </div>

      <div class="toolbar">
        <label class="select">
          <span>Theme</span>
          <select id="themeSel">
            <option value="dark">Dark</option>
            <option value="medium" selected>Medium</option>
            <option value="light">Light</option>
          </select>
        </label>

        <button class="btn btn--ghost" id="btnInstall" style="display:none" type="button">Installieren</button>
      </div>
    </div>
  </header>

  <main class="container">

    <!-- HERO -->
    <section class="card hero">
      <div class="hero__main">
        <div class="kicker">Arbeitszeit heute</div>
        <div class="timebig mono" id="heroWork">00:00:00</div>
        <div class="sub mono" id="heroSub">Pause 00:00:00 · Unterbr. 00:00:00</div>

        <div class="actions">
          <button class="btn btn--good btn--xl" id="workStart" type="button">Start</button>
          <button class="btn btn--warn btn--xl" id="workPause" type="button">Pause</button>
          <button class="btn btn--danger btn--xl" id="workStop" type="button">Stop</button>
        </div>

        <p class="hint">
          „Pause“ pausiert Arbeit. Wenn du im Mobi-Tab Pause drückst, startet zusätzlich die echte Pause (für 2-Tap-Flow).
        </p>
      </div>

      <aside class="hero__side">
        <div class="stat">
          <div class="stat__label">Status</div>
          <div class="stat__value mono" id="workStatus">stopped</div>
        </div>

        <div class="stat">
          <div class="stat__label">Pause</div>
          <div class="stat__value mono" id="breakStatus">stopped</div>
        </div>

        <div class="stat stat--big">
          <div class="stat__label">Geplantes Ende</div>
          <div class="stat__value mono" id="endTime">—</div>
          <div class="stat__sub mono" id="endSub">—</div>
        </div>

        <button class="btn btn--primary" id="btnFinishDay" type="button">Arbeitsende</button>
        <div class="mini mono" id="finishResult">—</div>
      </aside>
    </section>

    <!-- NORMAL -->
    <section id="viewNormal">

      <section class="card">
        <div class="card__title">Setup</div>

        <div class="grid">
          <label class="field">
            <span>Startzeit</span>
            <input type="time" id="dayStart" step="60" lang="de-DE" />
            <small>Wenn AM/PM sichtbar: einmal AM/PM auswählen, sonst bleibt “--”.</small>
          </label>

          <label class="field">
            <span>Soll (ohne Pause)</span>
            <input type="time" id="targetWork" value="07:00" step="60" />
          </label>

          <label class="field">
            <span>Pflichtpause</span>
            <input type="time" id="requiredBreak" value="00:45" step="60" />
          </label>

          <div class="field">
            <span>Quick</span>
            <button class="btn btn--primary btn--callout" id="btnStartNow" type="button">
              Start=jetzt & starten
            </button>

            <div class="toggles">
              <label class="toggle">
                <input type="checkbox" id="noGlide" />
                <span>Keine Gleitzeit</span>
              </label>

              <label class="toggle">
                <input type="checkbox" id="autoResume" checked />
                <span>Nach Pflichtpause zurück zu Arbeit</span>
              </label>

              <label class="toggle">
                <input type="checkbox" id="notifyOnBreak" />
                <span>Notification bei Pflichtpause</span>
              </label>

              <button class="btn btn--ghost" id="btnEnableNotify" type="button">Notifications</button>
            </div>
          </div>
        </div>
      </section>

      <section class="card" id="glideCard">
        <div class="card__title">Gleitzeit</div>

        <div class="grid grid--goal">
          <label class="field">
            <span>Konto aktuell (h)</span>
            <input type="text" inputmode="decimal" id="glideAccount" placeholder="0.51 oder 0,51" />
          </label>

          <label class="field">
            <span>Ziel</span>
            <select id="goalType">
              <option value="delta">Heute Δ (h)</option>
              <option value="account">Konto am Ende (h)</option>
            </select>
            <small>Δ = Arbeit − Soll (Pause zählt nicht in Δ)</small>
          </label>

          <label class="field">
            <span>Wert</span>
            <input type="text" inputmode="decimal" id="goalValue" placeholder="z.B. 1.0 oder -0.5" />
          </label>

          <div class="field">
            <span>&nbsp;</span>
            <button class="btn btn--primary" id="btnCalcGoal" type="button">Go-Time</button>
            <div class="result mono" id="goalResult">—</div>
          </div>
        </div>
      </section>

      <details class="card">
        <summary class="card__title">Erweitert</summary>

        <div class="divider"></div>

        <div class="sectionLabel">Nachtragen (Start vergessen)</div>
        <div class="grid grid--3">
          <label class="field">
            <span>Ich arbeite seit</span>
            <input type="time" id="workBackdateSince" step="60" />
          </label>

          <label class="field">
            <span>Oder: schon gearbeitet (Min)</span>
            <input type="number" min="0" step="1" id="workBackdateMinutes" placeholder="z.B. 30" />
          </label>

          <div class="field">
            <span>&nbsp;</span>
            <div class="row">
              <button class="btn btn--primary" id="btnApplyBackdate" type="button">Übernehmen</button>
              <button class="btn btn--ghost" id="btnApplyBackdateStart" type="button">… & Start</button>
            </div>
            <div class="result mono" id="backdateResult">—</div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="sectionLabel">Mobi-Rechner (für Eintragen)</div>
        <div class="grid grid--4">
          <label class="field">
            <span>Eintrag-Uhrzeit</span>
            <input type="time" id="entryTime" step="60" />
            <small>leer = jetzt</small>
          </label>

          <label class="field">
            <span>Tatsächlich aufgehört um</span>
            <input type="time" id="actualStopTime" step="60" />
            <small>leer = Eintrag</small>
          </label>

          <label class="field">
            <span>Pause (Min)</span>
            <input type="number" min="0" step="1" id="pauseMinutes" placeholder="z.B. 30" />
          </label>

          <div class="field">
            <span>&nbsp;</span>
            <button class="btn btn--primary" id="btnCalcEntryMinusPause" type="button">Ausrechnen</button>
            <div class="result mono" id="entryMinusPauseResult">—</div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="sectionLabel">Zeit – Minuten zurück</div>
        <div class="grid grid--4">
          <label class="field">
            <span>Basiszeit (optional)</span>
            <input type="time" id="baseTime" step="60" />
            <small>leer = jetzt</small>
          </label>

          <label class="field">
            <span>Minuten zurück</span>
            <input type="number" min="0" step="1" id="minutesAgo" placeholder="z.B. 45" />
          </label>

          <div class="field">
            <span>&nbsp;</span>
            <button class="btn btn--ghost" id="btnCalcAgo" type="button">Berechnen</button>
            <div class="result mono" id="agoResult">—</div>
          </div>

          <div class="field"></div>
        </div>
      </details>
    </section>

    <!-- MOBI -->
    <section id="viewMobi" style="display:none">
      <section class="card">
        <div class="card__title">Mobi</div>
        <p class="hint">Maximal simpel: Start / Pause / Stop. (Pause startet hier die echte Pause.)</p>

        <div class="mobi">
          <button class="btn btn--good btn--xl" id="mobiWorkStart" type="button">Start</button>
          <button class="btn btn--warn btn--xl" id="mobiPause" type="button">Pause</button>
          <button class="btn btn--danger btn--xl" id="mobiStop" type="button">Stop</button>
        </div>

        <div class="row" style="margin-top:12px; flex-wrap:wrap;">
          <button class="btn btn--primary btn--callout" id="mobiStartNow" type="button">Start=jetzt & starten</button>
          <button class="btn btn--primary" id="mobiFinish" type="button">Arbeitsende</button>
          <span class="result mono" id="mobiFinishResult">—</span>
        </div>
      </section>
    </section>

    <footer class="footer">
      <button class="btn btn--ghost" id="btnResetAll" type="button">Reset</button>
      <div class="footnote">PWA/Offline · localStorage</div>
    </footer>
  </main>

<script>
(() => {
  const $ = (id) => document.getElementById(id);
  const pad2 = (n) => String(n).padStart(2,"0");
  const KEY = "zeit_ui_v2";

  function formatHMS(sec){
    sec = Math.max(0, Math.floor(sec));
    const h = Math.floor(sec/3600);
    const m = Math.floor((sec%3600)/60);
    const s = sec%60;
    return `${pad2(h)}:${pad2(m)}:${pad2(s)}`;
  }
  function formatHM(d){ return `${pad2(d.getHours())}:${pad2(d.getMinutes())}`; }

  function parseHHMM(str){
    if(!str || !/^\d{2}:\d{2}$/.test(str)) return null;
    const [h,m] = str.split(":").map(Number);
    return h*3600 + m*60;
  }
  function todayAt(sec){
    const d = new Date();
    d.setHours(0,0,0,0);
    return new Date(d.getTime() + sec*1000);
  }
  function parseDecHours(str){
    if(!str) return 0;
    const v = Number(String(str).trim().replace(",", "."));
    return Number.isFinite(v) ? v : 0;
  }

  // PWA install prompt
  let deferredPrompt = null;
  window.addEventListener("beforeinstallprompt", (e) => {
    e.preventDefault();
    deferredPrompt = e;
    $("btnInstall").style.display = "inline-flex";
  });
  $("btnInstall").addEventListener("click", async () => {
    if(!deferredPrompt) return;
    deferredPrompt.prompt();
    try { await deferredPrompt.userChoice; } catch {}
    deferredPrompt = null;
    $("btnInstall").style.display = "none";
  });

  // Service Worker
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("./sw.js?v=20260227").catch(()=>{});
  }

  const defaultTimer = () => ({ status:"stopped", acc:0, lastStart:null });

  const state = {
    theme: "medium",
    tab: "normal",
    dayStart: "",
    targetWork: "07:00",
    requiredBreak: "00:45",
    noGlide: false,
    glideAccount: "",
    autoResume: true,
    notifyOnBreak: false,
    work: defaultTimer(),
    brk: defaultTimer(),
    off: defaultTimer(),
    breakAutoTimeoutId: null
  };

  function save(){ localStorage.setItem(KEY, JSON.stringify(state)); }
  function load(){
    const raw = localStorage.getItem(KEY);
    if(!raw) return;
    try{
      const obj = JSON.parse(raw);
      Object.assign(state, obj);
      state.work = obj.work || defaultTimer();
      state.brk  = obj.brk  || defaultTimer();
      state.off  = obj.off  || defaultTimer();
    }catch{}
  }

  function isRunning(t){ return t.status==="running" && typeof t.lastStart==="number"; }
  function startTimer(t){
    if(isRunning(t)) return;
    t.status="running"; t.lastStart=Date.now();
  }
  function pauseTimer(t){
    if(isRunning(t)) t.acc += (Date.now()-t.lastStart)/1000;
    t.status="paused"; t.lastStart=null;
  }
  function stopTimer(t){
    if(isRunning(t)) t.acc += (Date.now()-t.lastStart)/1000;
    t.status="stopped"; t.lastStart=null;
  }
  function seconds(t){
    let s=t.acc;
    if(isRunning(t)) s += (Date.now()-t.lastStart)/1000;
    return s;
  }

  function shouldOffRun(){
    const ds = parseHHMM(state.dayStart);
    if(ds===null) return false;
    if(Date.now() < todayAt(ds).getTime()) return false;
    return !isRunning(state.work) && !isRunning(state.brk);
  }
  function syncOff(){
    const want = shouldOffRun();
    if(want && !isRunning(state.off)) startTimer(state.off);
    if(!want && isRunning(state.off)) pauseTimer(state.off);
  }

  function plannedEndForDelta(deltaHours){
    const ds = parseHHMM(state.dayStart);
    const tw = parseHHMM(state.targetWork);
    const rb = parseHHMM(state.requiredBreak);
    if(ds===null || tw===null || rb===null) return null;

    const brTaken = seconds(state.brk);
    const offTaken = seconds(state.off);
    const brCounted = Math.max(rb, brTaken);

    const endMs = todayAt(ds).getTime() + (tw + deltaHours*3600 + brCounted + offTaken)*1000;
    return new Date(endMs);
  }
  function plannedEnd(){ return plannedEndForDelta(0); }

  // notifications (local only)
  function canNotify(){ return "Notification" in window; }
  async function requestNotify(){
    if(!canNotify()) return false;
    if(Notification.permission === "granted") return true;
    const p = await Notification.requestPermission();
    return p === "granted";
  }
  function notify(title, body){
    if(!canNotify()) return;
    if(Notification.permission !== "granted") return;
    try { new Notification(title, { body }); } catch {}
  }

  function clearBreakAutoTimer(){
    if(state.breakAutoTimeoutId){
      clearTimeout(state.breakAutoTimeoutId);
      state.breakAutoTimeoutId = null;
    }
  }
  function scheduleBreakAuto(){
    clearBreakAutoTimer();
    if(!state.autoResume) return;
    if(!isRunning(state.brk)) return;

    const rb = parseHHMM(state.requiredBreak);
    if(rb===null) return;

    const already = seconds(state.brk);
    const leftMs = Math.max(0, (rb - already) * 1000);

    state.breakAutoTimeoutId = setTimeout(() => {
      if(isRunning(state.brk)){
        stopTimer(state.brk);
        startTimer(state.work);
        if(state.notifyOnBreak) notify("Pflichtpause erfüllt", "Zurück zu Arbeit gestartet.");
        if(navigator.vibrate) navigator.vibrate([60,40,60]);
        save();
      }
    }, leftMs);
  }

  function updateTheme(){
    document.body.dataset.theme = state.theme;
    $("themeSel").value = state.theme;
  }
  function switchTab(tab){
    state.tab = tab;
    $("viewNormal").style.display = tab==="normal" ? "" : "none";
    $("viewMobi").style.display = tab==="mobi" ? "" : "none";
    $("tabNormal").classList.toggle("is-active", tab==="normal");
    $("tabMobi").classList.toggle("is-active", tab==="mobi");
    save();
  }

  function applyUI(){
    updateTheme();
    switchTab(state.tab);

    $("dayStart").value = state.dayStart || "";
    $("targetWork").value = state.targetWork || "07:00";
    $("requiredBreak").value = state.requiredBreak || "00:45";

    $("noGlide").checked = !!state.noGlide;
    $("glideAccount").value = state.glideAccount || "";
    $("glideCard").style.display = state.noGlide ? "none" : "";

    $("autoResume").checked = !!state.autoResume;
    $("notifyOnBreak").checked = !!state.notifyOnBreak;
  }

  function readUI(){
    state.theme = $("themeSel").value;
    state.dayStart = $("dayStart").value;
    state.targetWork = $("targetWork").value || "07:00";
    state.requiredBreak = $("requiredBreak").value || "00:45";
    state.noGlide = $("noGlide").checked;
    state.glideAccount = $("glideAccount").value || "";
    state.autoResume = $("autoResume").checked;
    state.notifyOnBreak = $("notifyOnBreak").checked;
    save();
    applyUI();
  }

  function startNowAndWork(){
    const n = new Date();
    const v = `${pad2(n.getHours())}:${pad2(n.getMinutes())}`;
    $("dayStart").value = v;
    readUI();
    stopTimer(state.brk);
    stopTimer(state.off);
    startTimer(state.work);
    save();
  }

  function finishDay(){
    stopTimer(state.work);
    stopTimer(state.brk);
    stopTimer(state.off);
    clearBreakAutoTimer();

    const tw = parseHHMM(state.targetWork);
    const worked = seconds(state.work);

    let msg = `Arbeit ${formatHMS(worked)}`;

    if(!state.noGlide && tw !== null){
      const deltaH = (worked - tw)/3600;
      const newAcc = parseDecHours(state.glideAccount) + deltaH;
      state.glideAccount = (Math.round(newAcc*100)/100).toFixed(2);
      $("glideAccount").value = state.glideAccount;
      msg = `Δ ${(deltaH>=0?"+":"")}${deltaH.toFixed(2)} h · Konto ${state.glideAccount} h`;
    }
    save();
    return msg;
  }

  function render(){
    const now = new Date();
    $("bigClock").textContent = `${pad2(now.getHours())}:${pad2(now.getMinutes())}:${pad2(now.getSeconds())}`;
    $("todayLine").textContent = now.toLocaleDateString("de-DE", { weekday:"long", year:"numeric", month:"2-digit", day:"2-digit" });

    syncOff();

    const w = seconds(state.work);
    const b = seconds(state.brk);
    const o = seconds(state.off);

    $("heroWork").textContent = formatHMS(w);
    $("heroSub").textContent = `Pause ${formatHMS(b)} · Unterbr. ${formatHMS(o)}`;
    $("workStatus").textContent = state.work.status;
    $("breakStatus").textContent = state.brk.status;

    const end = plannedEnd();
    if(end){
      $("endTime").textContent = formatHM(end);
      const rb = parseHHMM(state.requiredBreak) ?? 0;
      const brCounted = Math.max(rb, b);
      $("endSub").textContent = `Start ${state.dayStart || "—"} · Pause zählt ${formatHMS(brCounted)}`;
    } else {
      $("endTime").textContent = "—";
      $("endSub").textContent = "Startzeit setzen";
    }

    scheduleBreakAuto();
    save();
  }

  function hook(){
    $("tabNormal").addEventListener("click", ()=>switchTab("normal"));
    $("tabMobi").addEventListener("click", ()=>switchTab("mobi"));

    $("themeSel").addEventListener("change", readUI);

    ["dayStart","targetWork","requiredBreak","noGlide","glideAccount","autoResume","notifyOnBreak"].forEach(id=>{
      $(id).addEventListener("input", readUI);
      $(id).addEventListener("change", readUI);
    });

    $("btnStartNow").addEventListener("click", startNowAndWork);
    $("mobiStartNow").addEventListener("click", startNowAndWork);

    // normal controls
    $("workStart").addEventListener("click", ()=>{ stopTimer(state.brk); stopTimer(state.off); startTimer(state.work); save(); });
    $("workPause").addEventListener("click", ()=>{ pauseTimer(state.work); save(); });
    $("workStop").addEventListener("click", ()=>{ stopTimer(state.work); save(); });

    // mobi controls (pause starts real break)
    $("mobiWorkStart").addEventListener("click", ()=>{ stopTimer(state.brk); stopTimer(state.off); startTimer(state.work); save(); });
    $("mobiPause").addEventListener("click", ()=>{
      pauseTimer(state.work);
      startTimer(state.brk);
      save();
      scheduleBreakAuto();
    });
    $("mobiStop").addEventListener("click", ()=>{
      stopTimer(state.work);
      stopTimer(state.brk);
      stopTimer(state.off);
      clearBreakAutoTimer();
      save();
    });

    $("btnEnableNotify").addEventListener("click", async ()=>{
      const ok = await requestNotify();
      if(ok){
        state.notifyOnBreak = true;
        $("notifyOnBreak").checked = true;
        save();
        notify("Notifications aktiv", "Funktioniert, solange die App läuft.");
      }
    });

    $("btnFinishDay").addEventListener("click", ()=>{ $("finishResult").textContent = finishDay(); });
    $("mobiFinish").addEventListener("click", ()=>{ $("mobiFinishResult").textContent = finishDay(); });

    $("btnCalcGoal").addEventListener("click", ()=>{
      if(state.noGlide){ $("goalResult").textContent = "—"; return; }

      const type = $("goalType").value; // delta|account
      const v = parseDecHours($("goalValue").value);
      if(!Number.isFinite(v)){ $("goalResult").textContent = "—"; return; }

      const nowAcc = parseDecHours(state.glideAccount);
      const needDelta = (type === "delta") ? v : (v - nowAcc);

      const end = plannedEndForDelta(needDelta);
      $("goalResult").textContent = end ? `Go-Time ${formatHM(end)}` : "— Startzeit/Soll setzen";
    });

    function applyBackdate(alsoStart){
      const since = $("workBackdateSince").value;
      const minsStr = $("workBackdateMinutes").value;
      const now = new Date();

      if(since){
        const sec = parseHHMM(since);
        if(sec===null){ $("backdateResult").textContent="—"; return; }
        const diff = Math.max(0, (now.getTime() - todayAt(sec).getTime())/1000);
        state.work.acc = diff;
        state.work.status = alsoStart ? "running" : "paused";
        state.work.lastStart = alsoStart ? Date.now() : null;
        $("backdateResult").textContent = `OK (${formatHMS(diff)})`;
        save();
        return;
      }

      const mins = Number(minsStr);
      if(Number.isFinite(mins) && mins >= 0){
        state.work.acc = mins*60;
        state.work.status = alsoStart ? "running" : "paused";
        state.work.lastStart = alsoStart ? Date.now() : null;
        $("backdateResult").textContent = `OK (${formatHMS(mins*60)})`;
        save();
        return;
      }

      $("backdateResult").textContent = "—";
    }
    $("btnApplyBackdate").addEventListener("click", ()=>applyBackdate(false));
    $("btnApplyBackdateStart").addEventListener("click", ()=>applyBackdate(true));

    $("btnCalcEntryMinusPause").addEventListener("click", ()=>{
      const entry = $("entryTime").value;
      const stop  = $("actualStopTime").value;
      const pauseMin = Number($("pauseMinutes").value || 0);

      const now = new Date();
      const entrySec = entry ? parseHHMM(entry) : (now.getHours()*3600 + now.getMinutes()*60);
      const stopSec  = stop  ? parseHHMM(stop)  : entrySec;

      if(entrySec===null || stopSec===null || !Number.isFinite(pauseMin) || pauseMin < 0){
        $("entryMinusPauseResult").textContent = "—";
        return;
      }
      const base = todayAt(stopSec);
      const out = new Date(base.getTime() - pauseMin*60*1000);
      $("entryMinusPauseResult").textContent = `${formatHM(out)}`;
    });

    $("btnCalcAgo").addEventListener("click", ()=>{
      const base = $("baseTime").value;
      const mins = Number($("minutesAgo").value);
      if(!Number.isFinite(mins) || mins < 0){ $("agoResult").textContent="—"; return; }

      let baseDate;
      if(base){
        const sec = parseHHMM(base);
        if(sec===null){ $("agoResult").textContent="—"; return; }
        baseDate = todayAt(sec);
      } else {
        baseDate = new Date();
      }
      const d = new Date(baseDate.getTime() - mins*60*1000);
      $("agoResult").textContent = `${formatHM(d)}`;
    });

    $("btnResetAll").addEventListener("click", ()=>{
      if(!confirm("Reset?")) return;
      localStorage.removeItem(KEY);
      location.reload();
    });
  }

  load();
  applyUI();
  hook();
  render();
  setInterval(render, 250);
})();
</script>
</body>
</html>